<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>All Of Me</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="All Of Me">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="All Of Me">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="All Of Me">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="All Of Me" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/12680300?v=3&amp;s=460" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Justin Yang</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/aboutMe/index.html">关于我</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/AAC-Converter-Audio-Queue-Audio-Unit-MultipeerConnectivity/" style="font-size: 10px;">AAC Converter,Audio Queue,Audio Unit,MultipeerConnectivity</a> <a href="/tags/AirPlay-AirPlay设备自动选择/" style="font-size: 10px;">AirPlay,AirPlay设备自动选择</a> <a href="/tags/Audio-Unit-AUGraph-Mixer-混音/" style="font-size: 10px;">Audio Unit,AUGraph, Mixer,混音</a> <a href="/tags/Audio-Unit-变声处理/" style="font-size: 10px;">Audio Unit,变声处理</a> <a href="/tags/Cocoa-Touch-framework/" style="font-size: 10px;">Cocoa Touch,framework</a> <a href="/tags/JSObjection-面向协议编程-模块分离/" style="font-size: 10px;">JSObjection, 面向协议编程, 模块分离</a> <a href="/tags/UIScrollView-AutoLayout/" style="font-size: 10px;">UIScrollView,AutoLayout</a> <a href="/tags/hook-method-swizzling-埋点/" style="font-size: 10px;">hook,method swizzling,埋点</a> <a href="/tags/hook-汇编-函数传参-x86-64-armv7-arm64/" style="font-size: 10px;">hook,汇编, 函数传参,x86_64,armv7,arm64</a> <a href="/tags/私有库-framework/" style="font-size: 10px;">私有库,framework</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">iOS软件工程师</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Justin Yang</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="https://avatars1.githubusercontent.com/u/12680300?v=3&amp;s=460" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Justin Yang</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/aboutMe/index.html">关于我</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-iOS交换方法分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/06/14/iOS交换方法分析/" class="article-date">
  	<time datetime="2018-06-13T16:00:00.000Z" itemprop="datePublished">2018-06-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/14/iOS交换方法分析/">iOS传参分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="iOS传参分析"><a href="#iOS传参分析" class="headerlink" title="iOS传参分析"></a>iOS传参分析</h1><blockquote>
<p>通过此篇文章，您可以了解x86_64,arm32,arm64下各种函数调用的参数传递的方式；可以了解为什么arm64位下通过可变形参函数<code>hook</code>的<code>oc</code>方法取值会<code>crash</code>以及怎么解决的思考；基于参数传递原理，此<code>demo</code>对应的<code>BNRHookAction</code>类，可实现无侵入式埋点。</p>
</blockquote>
<h2 id=""><a href="#" class="headerlink" title=""></a>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hook-汇编-函数传参-x86-64-armv7-arm64/">hook,汇编, 函数传参,x86_64,armv7,arm64</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a  href="/2018/06/14/iOS交换方法分析/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-OC交换方法" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/27/OC交换方法/" class="article-date">
  	<time datetime="2017-08-26T16:00:00.000Z" itemprop="datePublished">2017-08-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/27/OC交换方法/">OC交换方法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="OC交换方法"><a href="#OC交换方法" class="headerlink" title="OC交换方法"></a>OC交换方法</h1><h3 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h3><ul>
<li>项目中要做无侵入式埋点</li>
<li>项目中要拦截某些函数，而让其执行特定代码后，不再执行原函数(如在做项目页面路由时，所有由其他app(或网页)唤起本app的页面，都用<code>window.rootViewController</code> <code>present</code>一个<code>navigationController</code>来呈现,nav的rootVC就是要呈现的这个界面，所以需要hook这个VC的返回按钮函数，当次VC不是nav的rootVC时，用pop返回,当是rootVC时用dismiss返回)</li>
<li>让所有被hook的函数都指向同一个函数</li>
</ul>
<p><a href="https://github.com/JustinYangJing/BNRHookAction.git">源码和使用说明地址</a><br>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hook-method-swizzling-埋点/">hook,method swizzling,埋点</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a  href="/2017/08/27/OC交换方法/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-面向协议编程应用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/07/13/面向协议编程应用/" class="article-date">
  	<time datetime="2017-07-12T16:00:00.000Z" itemprop="datePublished">2017-07-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/13/面向协议编程应用/">面向协议编程应用</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="面向协议编程应用"><a href="#面向协议编程应用" class="headerlink" title="面向协议编程应用"></a>面向协议编程应用</h1><h3 id="需求-对某些类的共性抽取，定义成协议-如百度地图和高德地图都有定位功能，如一些第三方厂商提供的相同功能的不同品牌模块，都可以把共性抽离做成协议，封装第三方厂商提供的lib文件并实现该协议"><a href="#需求-对某些类的共性抽取，定义成协议-如百度地图和高德地图都有定位功能，如一些第三方厂商提供的相同功能的不同品牌模块，都可以把共性抽离做成协议，封装第三方厂商提供的lib文件并实现该协议" class="headerlink" title="需求:对某些类的共性抽取，定义成协议(如百度地图和高德地图都有定位功能，如一些第三方厂商提供的相同功能的不同品牌模块，都可以把共性抽离做成协议，封装第三方厂商提供的lib文件并实现该协议)"></a>需求:对某些类的共性抽取，定义成协议(如百度地图和高德地图都有定位功能，如一些第三方厂商提供的相同功能的不同品牌模块，都可以把共性抽离做成协议，封装第三方厂商提供的lib文件并实现该协议)</h3>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JSObjection-面向协议编程-模块分离/">JSObjection, 面向协议编程, 模块分离</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a  href="/2017/07/13/面向协议编程应用/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-iOS音频编程之混音" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/19/iOS音频编程之混音/" class="article-date">
  	<time datetime="2017-04-18T16:00:00.000Z" itemprop="datePublished">2017-04-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/19/iOS音频编程之混音/">iOS音频编程之混音</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="iOS音频编程之混音"><a href="#iOS音频编程之混音" class="headerlink" title="iOS音频编程之混音"></a>iOS音频编程之混音</h1><h3 id="需求：多个音频源混合后输出，"><a href="#需求：多个音频源混合后输出，" class="headerlink" title="需求：多个音频源混合后输出，"></a>需求：多个音频源混合后输出，</h3><h3 id="项目说明：项目中采样4路音频源混合，音频源包含44100hz采样率，3000hz采样率，单声道和立体声-使用MixerVoiceHandle封装混音处理，用户只需要初始化音频文件路径数组，调用启动混音接口，就可实现多路音频混合输出"><a href="#项目说明：项目中采样4路音频源混合，音频源包含44100hz采样率，3000hz采样率，单声道和立体声-使用MixerVoiceHandle封装混音处理，用户只需要初始化音频文件路径数组，调用启动混音接口，就可实现多路音频混合输出" class="headerlink" title="项目说明：项目中采样4路音频源混合，音频源包含44100hz采样率，3000hz采样率，单声道和立体声;使用MixerVoiceHandle封装混音处理，用户只需要初始化音频文件路径数组，调用启动混音接口，就可实现多路音频混合输出"></a>项目说明：项目中采样4路音频源混合，音频源包含44100hz采样率，3000hz采样率，单声道和立体声;使用<code>MixerVoiceHandle</code>封装混音处理，用户只需要初始化音频文件路径数组，调用启动混音接口，就可实现多路音频混合输出</h3>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Audio-Unit-AUGraph-Mixer-混音/">Audio Unit,AUGraph, Mixer,混音</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a  href="/2017/04/19/iOS音频编程之混音/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-AirPlay" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/16/AirPlay/" class="article-date">
  	<time datetime="2016-07-15T16:00:00.000Z" itemprop="datePublished">2016-07-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/16/AirPlay/">AirPlay</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="AirPlay"><a href="#AirPlay" class="headerlink" title="AirPlay"></a>AirPlay</h2><blockquote>
<p>需求:绕过系统限制，自动选择支持<code>AirPlay</code>的设备</p>
</blockquote>
<h3 id="Airplay基础知识"><a href="#Airplay基础知识" class="headerlink" title="Airplay基础知识"></a>Airplay基础知识</h3><p>要调用出AirPlay列表需要使用到<code>MPVolumeView</code>控件，当系统检测到网络环境中有支持<code>AirPlay</code>的设备时才会出现<code>AirPlay</code>图标,用户点击这个图标，呼出支持<code>AirPlay</code>的设备列表。<br>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AirPlay-AirPlay设备自动选择/">AirPlay,AirPlay设备自动选择</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a  href="/2016/07/16/AirPlay/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-iOS音频编程之实时语音通信" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/14/iOS音频编程之实时语音通信/" class="article-date">
  	<time datetime="2016-07-13T16:00:00.000Z" itemprop="datePublished">2016-07-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/14/iOS音频编程之实时语音通信/">iOS音频编程之实时语音通信</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="iOS音频编程之实时语音通信"><a href="#iOS音频编程之实时语音通信" class="headerlink" title="iOS音频编程之实时语音通信"></a>iOS音频编程之实时语音通信</h1><h3 id="需求：手机通过Mic采集PCM编码的原始音频数据，将PCM转换为AAC编码格式，通过MultipeerConnectivity框架连接手机并发送AAC数据，在接收端使用Audio-Queue播放收到的AAC音频"><a href="#需求：手机通过Mic采集PCM编码的原始音频数据，将PCM转换为AAC编码格式，通过MultipeerConnectivity框架连接手机并发送AAC数据，在接收端使用Audio-Queue播放收到的AAC音频" class="headerlink" title="需求：手机通过Mic采集PCM编码的原始音频数据，将PCM转换为AAC编码格式，通过MultipeerConnectivity框架连接手机并发送AAC数据，在接收端使用Audio Queue播放收到的AAC音频"></a>需求：手机通过Mic采集PCM编码的原始音频数据，将PCM转换为AAC编码格式，通过MultipeerConnectivity框架连接手机并发送AAC数据，在接收端使用Audio Queue播放收到的AAC音频</h3>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AAC-Converter-Audio-Queue-Audio-Unit-MultipeerConnectivity/">AAC Converter,Audio Queue,Audio Unit,MultipeerConnectivity</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a  href="/2016/07/14/iOS音频编程之实时语音通信/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-iOS音频变成之变声处理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/09/iOS音频变成之变声处理/" class="article-date">
  	<time datetime="2016-06-08T16:00:00.000Z" itemprop="datePublished">2016-06-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/09/iOS音频变成之变声处理/">iOS音频编程之变声处理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="iOS音频编程之变声处理"><a href="#iOS音频编程之变声处理" class="headerlink" title="iOS音频编程之变声处理"></a>iOS音频编程之变声处理</h1><h3 id="需求：耳塞Mic实时录音，变声处理后实时输出"><a href="#需求：耳塞Mic实时录音，变声处理后实时输出" class="headerlink" title="需求：耳塞Mic实时录音，变声处理后实时输出"></a>需求：耳塞Mic实时录音，变声处理后实时输出</h3><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><h3 id="程序使用44100HZ的频率对原始的音频数据进行采样，并在音频输入的回调中处理采样的数据。"><a href="#程序使用44100HZ的频率对原始的音频数据进行采样，并在音频输入的回调中处理采样的数据。" class="headerlink" title="程序使用44100HZ的频率对原始的音频数据进行采样，并在音频输入的回调中处理采样的数据。"></a>程序使用44100HZ的频率对原始的音频数据进行采样，并在音频输入的回调中处理采样的数据。</h3><p>1）对AVAudioSession的一些设置</p>
<pre><code>&lt;!-- more --&gt;

NSError *error;
self.session = [AVAudioSession sharedInstance];
[self.session setCategory:AVAudioSessionCategoryPlayAndRecord error:&amp;error];
handleError(error);
//route变化监听
[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(audioSessionRouteChangeHandle:) name:AVAudioSessionRouteChangeNotification object:self.session];
[self.session setPreferredIOBufferDuration:0.005 error:&amp;error];
handleError(error);
[self.session setPreferredSampleRate:kSmaple error:&amp;error];
handleError(error);

[self.session setActive:YES error:&amp;error];
handleError(error);
</code></pre><p> <code>setPreferredIOBufferDurations</code>文档上解释<code>change to the I/O buffer duration</code>,具体解释参看官方文档。我把它理解为在每次调用输入或输出的回调，能提供多长时间(由设置的这个值决定)的音频数据。<br> <code>setPreferredSampleRate</code>设置对音频数据的采样率。</p>
<p> 2)获取AudioComponentInstance</p>
<pre><code>//Obtain a RemoteIO unit instance
AudioComponentDescription acd;
acd.componentType = kAudioUnitType_Output;
acd.componentSubType = kAudioUnitSubType_RemoteIO;
acd.componentFlags = 0;
acd.componentFlagsMask = 0;
acd.componentManufacturer = kAudioUnitManufacturer_Apple;
AudioComponent inputComponent = AudioComponentFindNext(NULL, &amp;acd);
AudioComponentInstanceNew(inputComponent, &amp;_toneUnit);
</code></pre><p> 3）对AudioComponentInstance的一些初始化设置<br> <center><br>    <img style="display:block;width:100%;" src="https://raw.githubusercontent.com/JustinYangJing/Resource/master/Image/Audio/1.png" alt="I/O unit"><br> </center><br> 这张图蓝色框中的部分就是一个<code>I/O Unit</code>(<code>AudioComponentInstance</code>的实例).图中的<code>Element 0</code>连接<code>Speaker</code>,也叫<code>Output Bus</code>;<code>Element 1</code>连接<code>Mic</code>,也叫<code>Input Bus</code>.初始化它，就是对再这些Bus上的音频流的格式，设置输入输出的回调函数等。</p>
<pre><code> UInt32 enable = 1;
AudioUnitSetProperty(_toneUnit,
                     kAudioOutputUnitProperty_EnableIO,
                     kAudioUnitScope_Input,
                     kInputBus,
                     &amp;enable,
                     sizeof(enable));
AudioUnitSetProperty(_toneUnit,
                     kAudioOutputUnitProperty_EnableIO,
                     kAudioUnitScope_Output,
                     kOutoutBus, &amp;enable, sizeof(enable));

mAudioFormat.mSampleRate         = kSmaple;//采样率
mAudioFormat.mFormatID           = kAudioFormatLinearPCM;//PCM采样
mAudioFormat.mFormatFlags        = kAudioFormatFlagIsSignedInteger | kAudioFormatFlagIsPacked;
mAudioFormat.mFramesPerPacket    = 1;//每个数据包多少帧
mAudioFormat.mChannelsPerFrame   = 1;//1单声道，2立体声
mAudioFormat.mBitsPerChannel     = 16;//语音每采样点占用位数
mAudioFormat.mBytesPerFrame      = mAudioFormat.mBitsPerChannel*mAudioFormat.mChannelsPerFrame/8;//每帧的bytes数
mAudioFormat.mBytesPerPacket     = mAudioFormat.mBytesPerFrame*mAudioFormat.mFramesPerPacket;//每个数据包的bytes总数，每帧的bytes数＊每个数据包的帧数
mAudioFormat.mReserved           = 0;

CheckError(AudioUnitSetProperty(_toneUnit,
                                kAudioUnitProperty_StreamFormat,
                                kAudioUnitScope_Input, kOutoutBus,
                                &amp;mAudioFormat, sizeof(mAudioFormat)),
           &quot;couldn&apos;t set the remote I/O unit&apos;s output client format&quot;);
CheckError(AudioUnitSetProperty(_toneUnit,
                                kAudioUnitProperty_StreamFormat,
                                kAudioUnitScope_Output, kInputBus,
                                &amp;mAudioFormat, sizeof(mAudioFormat)),
           &quot;couldn&apos;t set the remote I/O unit&apos;s input client format&quot;);

CheckError(AudioUnitSetProperty(_toneUnit,
                                kAudioOutputUnitProperty_SetInputCallback,
                                kAudioUnitScope_Output,
                                kInputBus,
                                &amp;_inputProc, sizeof(_inputProc)),
           &quot;couldnt set remote i/o render callback for input&quot;);

CheckError(AudioUnitSetProperty(_toneUnit,
                                kAudioUnitProperty_SetRenderCallback,
                                kAudioUnitScope_Input,
                                kOutoutBus,
                                &amp;_outputProc, sizeof(_outputProc)),
           &quot;couldnt set remote i/o render callback for output&quot;);

CheckError(AudioUnitInitialize(_toneUnit),
           &quot;couldn&apos;t initialize the remote I/O unit&quot;);
</code></pre><blockquote>
<p>注意<code>kAudioUnitScope_Output/kAudioUnitScope_Input</code>和<code>kOutput/kInput</code>的组合。设置输入输出使能时，Scope_Input下的kInput直接和Mic相连，所以是选用它们两;设置输出使能也类似。而设置音频的格式时，要选用Scope_Input下的kOutput和Scope_OutPut下的kInput,如果组合错误，为会返回-10865的错误码，意思说设置了只读属性，而在官方文档中也有说明,This hardware connection—at the input scope of element 1—is opaque to you. Your first access to audio data entering from the input hardware is at the output scope of element 1, output scope of element 0 is opaque。(<strong>疑问？在设置输入输出回调时以及Scope选择Input和Output以及Global都可以，但是官方文档中说<code>Your first access to audio data entering from the input hardware is at the output scope of element 1</code></strong>)</p>
</blockquote>
<h2 id="音频处理"><a href="#音频处理" class="headerlink" title="音频处理"></a>音频处理</h2><h3 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h3><p>变声操作实际是对声音信号的频谱进行搬移，在时域中乘以一个三角函数相当于在频域上进行了频谱的搬移。但使得频谱搬移了±𝑓。由下图傅里叶变化公式说明<br><img style="display:block;width:100%;" src="https://raw.githubusercontent.com/JustinYangJing/Resource/master/Image/Audio/2.png" alt="Fourier"><br>频谱搬移后，要把搬移的F(w-w。)的部分滤除。将声音的原始PCM放到Matlab中分析出频谱，然后进行搬移(<strong>实际上，我滤波这一步是失败的，还请小伙伴们告知我应该选一个怎样的滤波器</strong>)</p>
<p>1）写一个专门手机原始声音数据的程序，将声音数据保存到模拟上(用模拟器收集的声音，方便直接将写入到沙盒中的文件拷出来)。</p>
<p>2) 将声音数据用matlab读出来(注意模拟器和matlab处理数据时的大小端，专门把数据转换读出来看了，两边都应该是小端模式)，并分析和频移其频谱<br>matlab代码</p>
<pre><code>FID=fopen(&apos;record.txt&apos;,&apos;r&apos;);
fseek(FID,0,&apos;eof&apos;);
len=ftell(FID);
frewind(FID);
A=fread(FID,len/2,&apos;short&apos;);
A=A*1.0-mean(A);
Y=fft(A);
Fs=44100;
f=Fs*(0:length(A)/2 - 1)/length(A);
subplot(211);
plot(f,abs(Y(1:length(A)/2)));
k=0:length(A)-1;
cos_y=cos(2*pi*1000*k/44100);
cos_y=cos_y&apos;;
A2=A.*cos_y;
Y2=fft(A2);
subplot(212);
plot(f,abs(Y2(1:length(A)/2)));
</code></pre><p><img style="display:block;width:100%;" src="https://raw.githubusercontent.com/JustinYangJing/Resource/master/Image/Audio/3.png" alt="FFT "></p>
<p><strong>原始信号的频谱从0频开始?频率1000Hz后，虑除的就是小于1000hz的频率？实际在我的程序中对频谱只进行了200hz的搬移，那选一个大于200hz的IIR高通滤波器？</strong></p>
<p>3）用matlab设计滤波器，并得到滤波器参数.我用matlab的fdatool工具设计了一个5阶的IIR高通滤波器，截止频率为200hz。导出参数，用<code>[Bb,Ba]=sos2tf(SOS,G);</code>得出滤波器参数。</p>
<p>4）得到的Bb和Ba参数后，可以直接代入输入输出的差分方程得出滤波器的输出y(n)</p>
<h3 id="音频输入输出回调函数处理"><a href="#音频输入输出回调函数处理" class="headerlink" title="音频输入输出回调函数处理"></a>音频输入输出回调函数处理</h3><p>1）输入回调</p>
<pre><code>OSStatus inputRenderTone(
                     void *inRefCon,
                     AudioUnitRenderActionFlags     *ioActionFlags,
                     const AudioTimeStamp         *inTimeStamp,
                     UInt32                         inBusNumber,
                     UInt32                         inNumberFrames,
                     AudioBufferList             *ioData)

{
ViewController *THIS=(__bridge ViewController*)inRefCon;

AudioBufferList bufferList;
bufferList.mNumberBuffers = 1;
bufferList.mBuffers[0].mData = NULL;
bufferList.mBuffers[0].mDataByteSize = 0;
OSStatus status = AudioUnitRender(THIS-&gt;_toneUnit,
                                  ioActionFlags,
                                  inTimeStamp,
                                  kInputBus,
                                  inNumberFrames,
                                  &amp;bufferList);

SInt16 *rece = (SInt16 *)bufferList.mBuffers[0].mData;
for (int i = 0; i &lt; inNumberFrames; i++) {
    rece[i] = rece[i]*THIS-&gt;_convertCos[i];//频谱搬移
}

RawData *rawData = &amp;THIS-&gt;_rawData;
//距离最大位置还有mDataByteSize/2 那就直接memcpy,否则要一个一个字节拷贝
if((rawData-&gt;rear+bufferList.mBuffers[0].mDataByteSize/2) &lt;= kRawDataLen){
    memcpy((uint8_t *)&amp;(rawData-&gt;receiveRawData[rawData-&gt;rear]), bufferList.mBuffers[0].mData, bufferList.mBuffers[0].mDataByteSize);
    rawData-&gt;rear = (rawData-&gt;rear+bufferList.mBuffers[0].mDataByteSize/2);
}else{
    uint8_t *pIOdata = (uint8_t *)bufferList.mBuffers[0].mData;
    for (int i = 0; i &lt; rawData-&gt;rear+bufferList.mBuffers[0].mDataByteSize; i+=2) {
        SInt16 data = pIOdata[i] | pIOdata[i+1]&lt;&lt;8;
        rawData-&gt;receiveRawData[rawData-&gt;rear] = data;
        rawData-&gt;rear = (rawData-&gt;rear+1)%kRawDataLen;
    }
}
return status;
}
</code></pre><blockquote>
<p>在频移的处理时，本来要对频移后的序列滤波的，<strong>但是滤波后，全部是杂音</strong>，所以删除掉了这部分代码，在提供的完整代码中有这部分删除掉的代码。存储数据中循环队列来存。</p>
</blockquote>
<p>2）输出回调</p>
<pre><code>OSStatus outputRenderTone(
                      void *inRefCon,
                      AudioUnitRenderActionFlags     *ioActionFlags,
                      const AudioTimeStamp         *inTimeStamp,
                      UInt32                         inBusNumber,
                      UInt32                         inNumberFrames,
                      AudioBufferList             *ioData)

{
ViewController *THIS=(__bridge ViewController*)inRefCon;

SInt16 *outSamplesChannelLeft   = (SInt16 *)ioData-&gt;mBuffers[0].mData;
RawData *rawData = &amp;THIS-&gt;_rawData;
for (UInt32 frameNumber = 0; frameNumber &lt; inNumberFrames; ++frameNumber) {
   if (rawData-&gt;front != rawData-&gt;rear) {
        outSamplesChannelLeft[frameNumber] = (rawData-&gt;receiveRawData[rawData-&gt;front]);
        rawData-&gt;front = (rawData-&gt;front+1)%kRawDataLen;

    }
}
return 0;
}
</code></pre><p>以上实现了对音频的实时录入变声后实时输出。没有滤波，听起来声音有点怪。😂😂😂大学的时候学的数字信号处理已经还给老师，关于信号处理这部分还请知道的小伙伴指点指点,想实现男女声音转化的效果。</p>
<p><a href="https://github.com/JustinYangJing/ConvertVoiceTest.git" target="_blank" rel="external">代码下载地址</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Audio-Unit-变声处理/">Audio Unit,变声处理</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-创建私有库" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/11/创建私有库/" class="article-date">
  	<time datetime="2016-02-10T16:00:00.000Z" itemprop="datePublished">2016-02-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/11/创建私有库/">创建私有库</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Cocoapoads建立私有库"><a href="#Cocoapoads建立私有库" class="headerlink" title="Cocoapoads建立私有库"></a>Cocoapoads建立私有库</h1><p>该教程展示如何在github上建立自己的私有库，按照此教程也可应用在公司的git服务器上，使用pod对自己编写的库进行管理。</p>
<h2 id="在github上新建仓库"><a href="#在github上新建仓库" class="headerlink" title="在github上新建仓库"></a>在github上新建仓库</h2><ol>
<li>在github上新建MySpecs仓库(您可以命名为任意名字)，并新建<br> TestLib(您可以新建任意多个仓库，此仓库中的 工程便是您用pod<br> 管理的第三方库)仓库。</li>
<li><code>git clone https://github.com/xxxx/MySpecs.git</code>和<code>git clone https://github.com/xxxx/TestLib.git</code>(将地址换成您的仓库地址)。
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/私有库-framework/">私有库,framework</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a  href="/2016/02/11/创建私有库/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Xcode使用Cocoa Touch Framework新建Framework" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/11/Xcode使用Cocoa Touch Framework新建Framework/" class="article-date">
  	<time datetime="2016-01-10T16:00:00.000Z" itemprop="datePublished">2016-01-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/11/Xcode使用Cocoa Touch Framework新建Framework/">Xcode使用Cocoa Touch Framework新建Framework</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>网上有很多教程使用Xcode新建Framework的教程，不过使用的是Cocoa Touch Static Library，Xcode 6有一个新的功能,通过Cocoa Touch Framework。能直接生成Framework。</p>
</blockquote>
<h2 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h2><p>打开Xcode,新建工程，选择Cocoa Touch Framework,命名为xibFramework.<br><img style="display:block;width:80%;" src="https://raw.githubusercontent.com/JustinYangJing/Resource/master/Image/Framework/1.png" /><br>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cocoa-Touch-framework/">Cocoa Touch,framework</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a  href="/2016/01/11/Xcode使用Cocoa Touch Framework新建Framework/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ScrollView自动布局" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/10/ScrollView自动布局/" class="article-date">
  	<time datetime="2015-05-09T16:00:00.000Z" itemprop="datePublished">2015-05-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/10/ScrollView自动布局/">ScrollView自动布局</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="该篇文章将讲述对UIScrollView如何运用autoLayout-结合实例，根据显示的内容，自动调整scrollView的contentSize"><a href="#该篇文章将讲述对UIScrollView如何运用autoLayout-结合实例，根据显示的内容，自动调整scrollView的contentSize" class="headerlink" title="该篇文章将讲述对UIScrollView如何运用autoLayout, 结合实例，根据显示的内容，自动调整scrollView的contentSize"></a>该篇文章将讲述对UIScrollView如何运用autoLayout, 结合实例，根据显示的内容，自动调整scrollView的contentSize</h2><h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><h3 id="在Storyboard中的View-Controller的view中拖入一个scrollView-并在scrollView中添加一个UIView，层级关系如下图-包含所有添加的约束条件"><a href="#在Storyboard中的View-Controller的view中拖入一个scrollView-并在scrollView中添加一个UIView，层级关系如下图-包含所有添加的约束条件" class="headerlink" title="在Storyboard中的View Controller的view中拖入一个scrollView,并在scrollView中添加一个UIView，层级关系如下图(包含所有添加的约束条件)"></a>在Storyboard中的View Controller的view中拖入一个scrollView,并在scrollView中添加一个UIView，层级关系如下图(包含所有添加的约束条件)</h3><p><img style="display:block;width:80%;" src="https://raw.githubusercontent.com/JustinYangJing/Resource/master/Image/ScrollViewAutoLayout/1.png" alt="constrait" /><br>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UIScrollView-AutoLayout/">UIScrollView,AutoLayout</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/blog/">blog</a>
	</div>


      
        <p class="article-more-link">
          <a  href="/2015/05/10/ScrollView自动布局/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2020 Justin Yang
    	</div>
      <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
		</script>
    </div>
  </div>
  <div class="footer-right" style="margin-right:32px">
  <!--
  <span id="busuanzi_container_site_pv">
    访问量<span id="busuanzi_value_site_pv"></span>次
</span>
-->
<a href="http://www.miitbeian.gov.cn/">粤ICP备17074717号</a>
</div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>